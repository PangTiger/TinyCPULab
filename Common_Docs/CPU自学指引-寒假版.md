# CPU设计自学指引
快乐的寒假很适合用来自学CPU！

## 1. 之前没有接触过CPU相关的知识的同学
想要完成一个CPU的设计主要分为两大任务，首先，我们需要对CPU的结构有一个基本的概念，比如什么是单周期处理器？什么是MIPS指令集？为什么要引入流水线？什么是数据相关？什么是Cache？这部分的知识属于“计算机组成原理”，了解了这方面的知识之后，我们的头脑中会有一个较为初步和浅显的概念：CPU是由ALU、寄存器等基本的单元组成的。

之后，我们需要学会如何用代码来“描述”出一个完整的CPU，此时我们会接触到硬件描述语言（Hardware Discription Language)：Verilog/SystemVerilog，借助硬件描述语言，我们可以使用代码的形式来构建出ALU、寄存器等等CPU基本的单元，并将他们组装成一个完整的CPU。

#### 自学需要的先导知识
实际上，如果之前没有接触过数字电路的知识，你仍可以通过阅读《数字设计与计算机体系架构》的前半部分完成入门。所以笔者认为，大一的同学也完全可以通过自学达到大二和大三同学的水平：）传统的数字电路课程会花大量的时间纠结在一些元器件和冷知识上，通过自学的方式完全可以省下这部分时间；而且数字IC和CPU相较于艰深的物理或数学课而言，几乎没有前置知识的要求，入门门槛几乎为零，具备基本逻辑思维的初中生也完全能够掌握这部分知识。

但很遗憾，笔者大一的时候还很年轻，不知道CPU设计这么有趣；更遗憾的是，当年没有CPU兴趣小组来带带我，所以笔者直到大二下才完成了入门这一步。

#### 推荐学习路径
新手入门建议先阅读本文附录里提到的基础书籍，通过《计算机组成与设计：硬件与软件接口》来掌握计算机组成的基本原理，《数字设计与计算机体系架构》可以帮助你学习数字IC的基础知识。

阅读入门书籍的同时，可以在附录提到的HDLBits网站刷题来进一步熟悉SystemVerilog语法和基本的数字电路模块。

## 2. 上学期参加过一部分培训的同学
1. 如果已经听过粟涛老师讲解的处理器部分的知识，可以快速过一遍《计算机组成与设计：硬件与软件接口》以作复习。
2. 如果没有学习过Verilog/SystemVerilog相关的知识，强烈推荐《数字设计与计算机体系架构》，群文件/培训PPT中``Week0_SystemVerilog_V2``也是一份可以参考的资料。
3. 看完上述内容之后，建议去附录中提到的HDLbits网站刷题：https://hdlbits.01xz.net/
至少完成Getting Started和Veilog Language两部分的内容。

## 3. 完整参加过培训的同学
1. 基础书籍中的后面的章节还是有必要翻翻看看的，比如Cache的设计、乱序处理器的架构、分支预测等等，基础书籍中涉及的比较浅，通读下来能够有一个大致的概念。
2. 经过了这么多次的培训，SystemVerilog的基本语法大家已经掌握的差不多了，如果有遇到不了解或者不熟悉的概念，请参考群文件/推荐书籍/RTL_Mdeling_with_SystemVerilog，这是一本十分详细且权威的关于SV的语法书。
3. 如果之前还有一些实验没有完成，请尝试继续完成这些设计。
4. 如果之前所有的实验都顺利完成了，并且下学期仍有志于参加龙芯杯团队赛或个人赛的同学，有以下几种路径可以参考：
##### 参考路径
1. 你已经接触过《自》、《计算机系统设计》和李天瑞师兄的共三份代码，他们有着相似的模块和接口设计，他们的设计将组合逻辑的单元和流水线寄存器分开为不同的module文件，如``if.sv``, ``if_id.sv``，这样带来的好处是可以和我们头脑中的CPU框架一一对应，但也带来了模块例化的麻烦。你可以将原本的组合逻辑以及流水线寄存器放进同一个Module内，这样原本需要例化和连接两个模块的工作量将会减半，完成这个过程，其实你也实现了对原来代码的重构。这里可以参考2019年国科大的代码：https://github.com/nscscc2019ucas/nscscc2019ucas
2. 继续实现中断和异常。这部分的内容我们在培训中没有提到，但是对于CPU而言又是十分重要的一部分内容，具体的实现过程在《自》和《计算机系统设计》中都有涉及到。关于异常的处理阶段，这两本书是放置在访存级进行处理，其实你也完全可以放置在执行级进行处理。此外，他们关于CP0寄存器是设计在写回级进行写回，这会引入关于CP0寄存器的数据相关问题，而CP0寄存器完全可以在异常的处理阶段（执行级或访存级）就进行写入和读出，这可以减少数据相关的情况，简化设计。2019年国科大队伍的异常和中断是设计在执行级响应，CP0寄存器和HILO寄存器的的读写均放置在执行级，这减少了大量数据相关的情况，是一种很巧妙的优化。
3. 更改原本CPU的顶层接口，放进龙芯杯官方的团队赛测试环境中。龙芯官方对于团队赛提供了一个完整的Vivado工程进行测试，你需要将自己的CPU的顶层接口按照官方规定进行修改，然后将代码添加进龙芯的工程中，即可运行官方的功能测试。官方的功能测试提供了非常完整的测试例程，并且通过对比写回级的PC、写寄存器值等信号，能够帮助你判断CPU在哪一条PC处功能有问题，非常适合Debug。拥有这套测试环境之后你就不需要自己写测试例程testbench了。
4. 如果你有志于参加龙芯杯团体赛，且你比较强（不要害羞，实验做这么快是很强的dalao了），这里**强烈建议**寒假自学一下Cache的设计。由于Cache是影响处理器性能的关键中的关键，单发射五级流水的CPU的IPC都接近于1，提高性能只能依靠Cache。根据往届的经验来看，没有实现Cache的队伍性能分大约在1分左右，而实现cache之后性能分起码能有25分以上，这就可以稳稳拿到龙芯杯决赛三等奖了：）
    
## 附录：自学书籍推荐
#### 基础书籍
1. 《计算机组成与设计：硬件与软件接口》：一本十分经典的讲计算机组成原理的好书，两位作者也是该领域的大牛。对于兴趣在于硬件设计的同学，本书前五章的内容包括了处理器和Cache（缓存）的基本知识，看完此书你能够对处理器的基本框架有一个比较清楚的认识。
2. 《数字设计与计算机体系架构》：Digital Design and Computer Architecture, 简称是DDCA。这本书前五章系统的讲解了数字集成电路设计里从门电路到硬件描述语言的必备知识，后三章重点介绍了计算机体系结构的必要知识，通读此书你就能获得CPU设计的所有必备知识了！本书的前五章能够帮助你快速掌握数字IC最基本的知识，你能通过书中给出的例子慢慢熟悉SystemVerilog这门硬件描述语言，对新手比较友好。书中的后三章可以结合《计算机组成与设计：硬件与软件接口》一起食用效果更佳 : )
3. 《大话处理器-处理器基础知识读本》，这本书是我近期发现的一本科普书，语言非常诙谐有趣，很适合闲暇之余当作故事书来翻翻看。
#### 进阶书籍
4. 《自己动手写CPU》，一本真正手把手教你写CPU的书，书的前三章简单介绍了Verilog、五级流水线处理器的结构等等，从第四章开始，这本书会从最简单的MIPS逻辑运算指令ORI开始，逐步增加CPU支持的MIPS指令，最终实现一个功能比较完备的MIPS处理器。这本书建议初步读完前两本入门书籍之后再开始阅读，此书可操作性很强，附有完整的代码，初学者完全可以一步步按照书中的指导在自己的电脑上跑起来。
5. 《计算机系统设计(上)：基于FPGA的RISC处理器设计与实现》，这本书出版时间比《自》晚几年，在内容和处理器的结构上借鉴了《自》，但改掉了《自》中一些不好的代码风格（很不幸的是，此书也引入了一些不好的设计）。此书前几章会先介绍汇编语言、Vivado的基本使用等，属于新手福音：）书中的后半部分也会由简入难的实现一个CPU，也附上了详细的代码。此外，这本书还有作者录制的视频讲解，视频搭配书籍食用效果更佳：）此书的视频、源代码、虚拟机等资源我已经上传到"CPUisCool"的群文件/《计算机系统设计》书籍配套资料中。

## 附录：刷题网站推荐
纸上得来终觉浅，绝知此事要躬行。看书看的多了，难免会看腻的，此时不如去刷几道电路设计的题目清醒一下头脑。强烈推荐刷题网站HDLbits：https://hdlbits.01xz.net/

HDLbits是一个不错的在线"刷题"网站，它会提出设计需求，要求你在指定的文本框中写出代码来完成设计，网站共有6个Topics，前两个Topics属于新手福音，能够帮助你快速熟悉SystemVerilog的用法，后四个Topics分别是组合逻辑、时序逻辑、阅读仿真、写Testbench测试文件，不仅适合初学者入门，也适合用来系统的复习一遍数字设计的知识。此网站建议长期食用，如果觉得题目太多比较头大的话，刷完前两个新手福音的章节之后可以每个子话题挑几个题目来做：）

补充：知乎上有一个关于HDLbits的专栏：HDLBits中文导学，链接：https://www.zhihu.com/column/c_1131528588117385216，其详细介绍了每一道题目的写法和原理，但作者是使用Verilog来完成的（SystemVerilog是Verilog的扩展，类似于C++与C的关系，SystemVerilog引入了新的数据类型和不同的关键字来避免设计者犯错），对于初学者而言，入门用Verilog还是systemVerilog都可以，建议都简单了解一下。此外，群文件/文档资料/HDLBits.zip是李天瑞师兄使用原汁原味的SystemVerilog语法完成的刷题的答案，可以和知乎的专栏搭配食用。